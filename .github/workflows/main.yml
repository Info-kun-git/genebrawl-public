name: Build APK from Uploaded ZIP

on:
  workflow_dispatch:
    inputs:
      frida_version:
        description: 'Ð’ÐµÑ€ÑÐ¸Ñ Frida'
        default: '16.1.11'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¤ Upload your ZIP here first
        uses: actions/upload-artifact@v4
        with:
          name: input-bundle
          path: /tmp/upload
      
      # ... Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ð¾Ðµ Ñ‚Ð¾ Ð¶Ðµ ÑÐ°Ð¼Ð¾Ðµ

      - name: ðŸ“¥ Setup & Download
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq wget unzip zip
          
          mkdir -p /tmp/work
          
          # Ð•ÑÐ»Ð¸ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾ Ð¸Ð¼Ñ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð° - ÑÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ñ‡ÐµÑ€ÐµÐ· API
          if [ -n "${{ inputs.artifact_name }}" ]; then
            echo "ðŸ“¦ Ð˜Ñ‰ÐµÐ¼ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚: ${{ inputs.artifact_name }}"
            
            # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð²ÑÐµÑ… Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²
            curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${{ github.repository }}/actions/artifacts?per_page=100" \
              > /tmp/artifacts.json
            
            # Ð˜Ñ‰ÐµÐ¼ Ð¿Ð¾ Ð¸Ð¼ÐµÐ½Ð¸
            ARTIFACT_ID=$(cat /tmp/artifacts.json | jq -r ".artifacts[] | select(.name==\"${{ inputs.artifact_name }}\") | .id" | head -1)
            
            if [ -z "$ARTIFACT_ID" ]; then
              echo "âŒ ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹:"
              cat /tmp/artifacts.json | jq -r '.artifacts[].name' | head -20
              exit 1
            fi
            
            echo "âœ… ÐÐ°Ð¹Ð´ÐµÐ½ ID: $ARTIFACT_ID"
            
            # Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼
            curl -L -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -o /tmp/work/download.zip \
              "https://api.github.com/repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip"
            
          else
            echo "âš ï¸ Ð˜Ð¼Ñ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð° Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾"
            echo "ðŸ“¤ Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸ Ñ„Ð°Ð¹Ð» Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ñ‡ÐµÑ€ÐµÐ· Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ Ð¸Ð»Ð¸ ÑƒÐºÐ°Ð¶Ð¸ Ð¸Ð¼Ñ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð°"
            exit 1
          fi
          
          echo "âœ… Ð¤Ð°Ð¹Ð» ÑÐºÐ°Ñ‡Ð°Ð½:"
          ls -lh /tmp/work/download.zip
      
      - name: ðŸ“‚ Extract bundle.js
        run: |
          cd /tmp/work
          
          # Ð Ð°ÑÐ¿Ð°ÐºÐ¾Ð²Ñ‹Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ (GitHub wrapper)
          unzip -q download.zip
          echo "ÐŸÐ¾ÑÐ»Ðµ Ð¿ÐµÑ€Ð²Ð¾Ð¹ Ñ€Ð°ÑÐ¿Ð°ÐºÐ¾Ð²ÐºÐ¸:"
          ls -la
          
          # Ð˜Ñ‰ÐµÐ¼ Ð²Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½Ð¸Ð¹ ZIP
          INNER=$(find . -name "*.zip" | head -1)
          if [ -n "$INNER" ]; then
            echo "ðŸ“‚ Ð Ð°ÑÐ¿Ð°ÐºÐ¾Ð²Ñ‹Ð²Ð°ÐµÐ¼: $INNER"
            unzip -q "$INNER" -d extracted/
          else
            mkdir -p extracted
            mv *.js *.txt extracted/ 2>/dev/null || true
          fi
          
          echo "Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ð¾Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ:"
          find extracted -type f
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ bundle.js
          BUNDLE=$(find extracted -name "bundle.js" | head -1)
          if [ -z "$BUNDLE" ]; then
            echo "âŒ bundle.js Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
            exit 1
          fi
          
          cp "$BUNDLE" /tmp/bundle.js
          echo "âœ… bundle.js Ð³Ð¾Ñ‚Ð¾Ð²:"
          ls -lh /tmp/bundle.js
          head -5 /tmp/bundle.js
      
      - name: ðŸ”§ Setup Android SDK
        run: |
          mkdir -p $HOME/android-sdk
          cd $HOME/android-sdk
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q commandlinetools-linux-9477386_latest.zip
          mkdir -p cmdline-tools/latest
          mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
          
          export ANDROID_HOME=$HOME/android-sdk
          export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH
          
          yes | sdkmanager --licenses >/dev/null 2>&1 || true
          sdkmanager "build-tools;33.0.0" "platforms;android-33" >/dev/null 2>&1
          echo "$ANDROID_HOME/build-tools/33.0.0" >> $GITHUB_PATH
      
      - name: ðŸ—ï¸ Build APK
        run: |
          WORK="/tmp/apk"
          mkdir -p $WORK/lib/{arm64-v8a,armeabi-v7a} $WORK/assets/genebrawl
          
          FRIDA="${{ inputs.frida_version }}"
          echo "â¬‡ï¸ Frida Gadget $FRIDA..."
          
          wget -q "https://github.com/frida/frida/releases/download/$FRIDA/frida-gadget-$FRIDA-android-arm64.so" -O $WORK/lib/arm64-v8a/libfrida-gadget.so
          wget -q "https://github.com/frida/frida/releases/download/$FRIDA/frida-gadget-$FRIDA-android-arm.so" -O $WORK/lib/armeabi-v7a/libfrida-gadget.so
          
          # ÐšÐ¾Ð½Ñ„Ð¸Ð³
          echo '{"interaction":{"type":"script","path":"/data/local/tmp/genebrawl.js","on_change":"reload"}}' | tee $WORK/lib/arm64-v8a/libfrida-gadget.config.so | tee $WORK/lib/armeabi-v7a/libfrida-gadget.config.so > /dev/null
          
          # Manifest
          cat > $WORK/AndroidManifest.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android" package="com.genebrawl.mod" android:versionCode="1" android:versionName="1.0">
            <uses-sdk android:minSdkVersion="21" android:targetSdkVersion="33"/>
            <application android:label="Gene Brawl Mod" android:hasCode="false" android:extractNativeLibs="true">
              <activity android:name="android.app.NativeActivity" android:exported="true" android:configChanges="orientation|screenSize|smallestScreenSize">
                <intent-filter><action android:name="android.intent.action.MAIN"/><category android:name="android.intent.category.LAUNCHER"/></intent-filter>
                <meta-data android:name="android.app.lib_name" android:value="frida-gadget"/>
              </activity>
            </application>
          </manifest>
          EOF
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ bundle
          cp /tmp/bundle.js $WORK/assets/genebrawl/
          cp /tmp/bundle.js /tmp/genebrawl.js
          
          # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ APK
          cd $WORK
          zip -r /tmp/unsigned.apk . -x ".*"
          
          # ÐŸÐ¾Ð´Ð¿Ð¸ÑÑŒ
          keytool -genkey -v -keystore /tmp/debug.keystore -alias androiddebugkey -storepass android -keypass android -keyalg RSA -validity 10000 -dname "CN=Android Debug,O=Android,C=US" 2>&1 | tail -2
          apksigner sign --ks /tmp/debug.keystore --ks-pass pass:android --key-pass pass:android --out /tmp/gene-brawl-mod.apk /tmp/unsigned.apk
          
          echo "âœ… APK ÑÐ¾Ð±Ñ€Ð°Ð½:"
          ls -lh /tmp/gene-brawl-mod.apk
      
      - name: ðŸ“¦ Package & Upload
        run: |
          mkdir -p /tmp/final/gene-brawl-apk
          cp /tmp/gene-brawl-mod.apk /tmp/final/gene-brawl-apk/
          cp /tmp/bundle.js /tmp/final/gene-brawl-apk/
          cp /tmp/genebrawl.js /tmp/final/gene-brawl-apk/push_to_device.js
          
          cat > /tmp/final/gene-brawl-apk/README.txt << 'EOF'
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘     GENE BRAWL MOD - Ð“ÐžÐ¢ÐžÐ’Ð«Ð™ APK               â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          âš ï¸ Ð¢Ð Ð•Ð‘Ð£Ð•Ð¢Ð¡Ð¯ ROOT!
          
          1. adb install gene-brawl-mod.apk
          2. adb push push_to_device.js /data/local/tmp/genebrawl.js
          3. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸ "Gene Brawl Mod" Ð½Ð° Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ðµ
          4. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸ Ð¸Ð³Ñ€Ñƒ
          
          Ð˜Ð»Ð¸ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ: frida -U Gadget -l bundle.js
          EOF
          
          cd /tmp/final
          zip -r gene-brawl-apk.zip gene-brawl-apk/
      
      - name: ðŸ“¤ Upload
        uses: actions/upload-artifact@v4
        with:
          name: gene-brawl-apk-final
          path: /tmp/final/gene-brawl-apk.zip
      
      - name: ðŸŽ‰ Done
        run: |
          echo "âœ… Ð“ÐžÐ¢ÐžÐ’Ðž!"
          echo "Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°Ð¹: gene-brawl-apk-final.zip"
          echo "Ð¢Ð°Ð¼: APK + bundle.js + Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ"
