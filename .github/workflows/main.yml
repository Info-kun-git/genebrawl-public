name: Build Gene Brawl APK

on:
  workflow_dispatch:
    inputs:
      bundle_url:
        description: 'URL Ðº ZIP Ñ bundle.js (Ð¸Ð»Ð¸ Ð¾ÑÑ‚Ð°Ð²ÑŒ Ð¿ÑƒÑÑ‚Ñ‹Ð¼ Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð°)'
        required: false
        default: ''
        type: string
      frida_version:
        description: 'Ð’ÐµÑ€ÑÐ¸Ñ Frida Gadget'
        required: true
        default: '16.1.11'
        type: string
      gadget_interaction:
        description: 'Ð ÐµÐ¶Ð¸Ð¼ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Gadget'
        required: true
        default: 'script'
        type: choice
        options:
          - script (Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° JS)
          - listen (Ð¶Ð´ÐµÑ‚ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ)

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Java & Android SDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq wget unzip zip
          
          # Android SDK
          mkdir -p $HOME/android-sdk
          cd $HOME/android-sdk
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q commandlinetools-linux-9477386_latest.zip
          mkdir -p cmdline-tools/latest
          mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
          
          export ANDROID_HOME=$HOME/android-sdk
          export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH
          
          yes | sdkmanager --licenses >/dev/null 2>&1 || true
          sdkmanager "build-tools;33.0.0" "platforms;android-33" >/dev/null 2>&1
          
          # Apktool
          cd /tmp
          wget -q https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool
          wget -q https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.9.3.jar
          chmod +x apktool
          sudo mv apktool /usr/local/bin/
          sudo mv apktool_2.9.3.jar /usr/local/bin/apktool.jar
          
          echo "âœ… Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
      
      - name: â¬‡ï¸ Download bundle.js
        run: |
          mkdir -p /tmp/bundle_src
          
          if [ -n "${{ inputs.bundle_url }}" ]; then
            echo "â¬‡ï¸ Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ðµ Ñ URL: ${{ inputs.bundle_url }}"
            wget -q "${{ inputs.bundle_url }}" -O /tmp/bundle_src/bundle.zip
          else
            echo "ðŸ“¦ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ Ð¸Ð· Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÐµÐ³Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°..."
            # ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ ÑÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ð¹ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚
            curl -s "https://api.github.com/repos/${{ github.repository }}/actions/artifacts?per_page=10" \
              | grep -o '"archive_download_url": "[^"]*"' \
              | head -1 \
              | cut -d'"' -f4 > /tmp/artifact_url.txt
            
            if [ -s /tmp/artifact_url.txt ]; then
              ARTIFACT_URL=$(cat /tmp/artifact_url.txt)
              echo "ÐÐ°Ð¹Ð´ÐµÐ½ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚: $ARTIFACT_URL"
              # ÐÑƒÐ¶ÐµÐ½ Ñ‚Ð¾ÐºÐµÐ½ Ð´Ð»Ñ ÑÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ñ
              curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -o /tmp/bundle_src/bundle.zip "$ARTIFACT_URL" 2>/dev/null || \
                echo "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚, ÑÐ¾Ð·Ð´Ð°Ð´Ð¸Ð¼ dummy"
            else
              echo "âš ï¸ ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹"
            fi
          fi
          
          # Ð Ð°ÑÐ¿Ð°ÐºÐ¾Ð²Ñ‹Ð²Ð°ÐµÐ¼ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ
          if [ -f "/tmp/bundle_src/bundle.zip" ]; then
            cd /tmp/bundle_src
            unzip -q bundle.zip 2>/dev/null || true
            find . -name "bundle.js" -exec cp {} /tmp/bundle.js \;
          fi
          
          # Ð•ÑÐ»Ð¸ Ð½Ðµ Ð½Ð°ÑˆÐ»Ð¸ bundle.js, ÑÐ¾Ð·Ð´Ð°Ñ‘Ð¼ placeholder
          if [ ! -f "/tmp/bundle.js" ]; then
            echo '// Placeholder - Ð·Ð°Ð¼ÐµÐ½Ð¸ Ð½Ð° Ð½Ð°ÑÑ‚Ð¾ÑÑ‰Ð¸Ð¹ bundle.js' > /tmp/bundle.js
            echo "âš ï¸ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ placeholder! Ð—Ð°Ð¼ÐµÐ½Ð¸ bundle.js Ð¿ÐµÑ€ÐµÐ´ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼."
          fi
          
          ls -lh /tmp/bundle.js
      
      - name: ðŸ—ï¸ Build APK structure
        run: |
          WORK_DIR="/tmp/gene_apk"
          mkdir -p $WORK_DIR/{lib/arm64-v8a,lib/armeabi-v7a,assets/genebrawl,META-INF}
          
          # Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Frida Gadget
          FRIDA_VER="${{ inputs.frida_version }}"
          echo "â¬‡ï¸ Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ðµ Frida Gadget $FRIDA_VER..."
          
          wget -q "https://github.com/frida/frida/releases/download/$FRIDA_VER/frida-gadget-$FRIDA_VER-android-arm64.so" \
            -O $WORK_DIR/lib/arm64-v8a/libfrida-gadget.so
          wget -q "https://github.com/frida/frida/releases/download/$FRIDA_VER/frida-gadget-$FRIDA_VER-android-arm.so" \
            -O $WORK_DIR/lib/armeabi-v7a/libfrida-gadget.so
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ bundle.js
          cp /tmp/bundle.js $WORK_DIR/assets/genebrawl/bundle.js
          cp /tmp/bundle.js /tmp/genebrawl.js
          
          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ Ð´Ð»Ñ Gadget
          if [ "${{ inputs.gadget_interaction }}" == "script" ]; then
            CONFIG='{"interaction":{"type":"script","path":"/data/local/tmp/genebrawl.js","on_change":"reload"}}'
          else
            CONFIG='{"interaction":{"type":"listen","address":"127.0.0.1","port":27042}}'
          fi
          
          echo "$CONFIG" | tee $WORK_DIR/lib/arm64-v8a/libfrida-gadget.config.so \
            | tee $WORK_DIR/lib/armeabi-v7a/libfrida-gadget.config.so > /dev/null
          
          # AndroidManifest.xml
          cat > $WORK_DIR/AndroidManifest.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              package="com.genebrawl.mod"
              android:versionCode="1"
              android:versionName="1.0">
              <uses-sdk android:minSdkVersion="21" android:targetSdkVersion="33"/>
              <application 
                  android:label="Gene Brawl Mod"
                  android:hasCode="false"
                  android:extractNativeLibs="true">
                  <activity 
                      android:name="android.app.NativeActivity"
                      android:exported="true"
                      android:configChanges="orientation|screenSize|smallestScreenSize">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN"/>
                          <category android:name="android.intent.category.LAUNCHER"/>
                      </intent-filter>
                      <meta-data android:name="android.app.lib_name" android:value="frida-gadget"/>
                  </activity>
              </application>
          </manifest>
          EOF
          
          echo "âœ… Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° APK Ð³Ð¾Ñ‚Ð¾Ð²Ð°"
          find $WORK_DIR -type f | head -10
      
      - name: ðŸ“¦ Pack & Sign APK
        run: |
          WORK_DIR="/tmp/gene_apk"
          cd $WORK_DIR
          
          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ APK (ZIP)
          zip -r /tmp/gene-brawl-unsigned.apk . -x ".*"
          
          # Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ»ÑŽÑ‡
          keytool -genkey -v \
            -keystore /tmp/debug.keystore \
            -alias androiddebugkey \
            -storepass android \
            -keypass android \
            -keyalg RSA \
            -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US" 2>&1 | tail -3
          
          # ÐŸÐ¾Ð´Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼
          $ANDROID_HOME/build-tools/33.0.0/apksigner sign \
            --ks /tmp/debug.keystore \
            --ks-pass pass:android \
            --key-pass pass:android \
            --out /tmp/gene-brawl-mod.apk \
            /tmp/gene-brawl-unsigned.apk
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼
          $ANDROID_HOME/build-tools/33.0.0/apksigner verify /tmp/gene-brawl-mod.apk
          
          echo "âœ… APK Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ð½"
          ls -lh /tmp/gene-brawl-mod.apk
      
      - name: ðŸ“‹ Create Release Package
        run: |
          OUTPUT_DIR="/tmp/output"
          mkdir -p $OUTPUT_DIR/gene-brawl-apk
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹
          cp /tmp/gene-brawl-mod.apk $OUTPUT_DIR/gene-brawl-apk/
          cp /tmp/bundle.js $OUTPUT_DIR/gene-brawl-apk/bundle.js
          cp /tmp/genebrawl.js $OUTPUT_DIR/gene-brawl-apk/genebrawl.js
          
          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸ÑŽ
          cat > $OUTPUT_DIR/gene-brawl-apk/README.txt << EOF
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘              GENE BRAWL MOD - Ð“ÐžÐ¢ÐžÐ’Ð«Ð™ APK                    â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ðŸ“ Ð¤ÐÐ™Ð›Ð«:
          â”œâ”€â”€ gene-brawl-mod.apk    â† Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸ Ð½Ð° Android (Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ ROOT!)
          â”œâ”€â”€ bundle.js             â† Ð˜ÑÑ…Ð¾Ð´Ð½Ñ‹Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚
          â””â”€â”€ genebrawl.js          â† Ð”Ð»Ñ /data/local/tmp/
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ðŸ“± Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ (Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ ROOT!)
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          1. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸ APK:
             adb install gene-brawl-mod.apk
          
          2. ÐŸÐ¾Ð»Ð¾Ð¶Ð¸ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ:
             adb push genebrawl.js /data/local/tmp/genebrawl.js
             adb shell chmod 644 /data/local/tmp/genebrawl.js
          
          3. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸ "Gene Brawl Mod" Ð½Ð° Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ðµ
          
          4. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸ Ð¸Ð³Ñ€Ñƒ Gene Brawl (Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾)
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ðŸ”§ Ð Ð£Ð§ÐÐžÐ™ Ð—ÐÐŸÐ£Ð¡Ðš (Ñ‡ÐµÑ€ÐµÐ· Frida)
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Android:
             frida -U Gadget -l bundle.js
          
          iOS:
             frida -U -f com.supercell.laser -l bundle.js --no-pause
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          âš ï¸ Ð’ÐÐ–ÐÐž
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          - Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ ROOT (Magisk/KernelSU)
          - Ð Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð¢ÐžÐ›Ð¬ÐšÐž Ñ Gene Brawl
          - Ð”Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¼Ð¾Ð´Ð°: adb push bundle.js /data/local/tmp/genebrawl.js
          
          Ð¡Ð±Ð¾Ñ€ÐºÐ°: ${{ github.run_number }} | Frida: ${{ inputs.frida_version }}
          EOF
          
          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ ZIP
          cd $OUTPUT_DIR
          zip -r gene-brawl-apk.zip gene-brawl-apk/
          
          echo "âœ… ÐŸÐ°ÐºÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½"
          ls -lh gene-brawl-apk.zip
      
      - name: ðŸ“¤ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: gene-brawl-apk-${{ github.run_number }}
          path: /tmp/output/gene-brawl-apk.zip
          retention-days: 30
      
      - name: ðŸŽ‰ Summary
        run: |
          echo "=========================================="
          echo "âœ… APK Ð£Ð¡ÐŸÐ•Ð¨ÐÐž Ð¡ÐžÐ‘Ð ÐÐ!"
          echo "=========================================="
          echo ""
          echo "ðŸ“¦ Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ: Actions â†’ ÑÑ‚Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑÐº â†’ Artifacts"
          echo ""
          echo "ðŸ“± Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°:"
          echo "  1. Ð Ð°ÑÐ¿Ð°ÐºÑƒÐ¹ gene-brawl-apk.zip"
          echo "  2. adb install gene-brawl-mod.apk"
          echo "  3. adb push genebrawl.js /data/local/tmp/genebrawl.js"
          echo "  4. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸ 'Gene Brawl Mod' Ð½Ð° Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ðµ"
          echo ""
          echo "ðŸ”§ Frida Ð²ÐµÑ€ÑÐ¸Ñ: ${{ inputs.frida_version }}"
          echo "ðŸ”§ Ð ÐµÐ¶Ð¸Ð¼: ${{ inputs.gadget_interaction }}"
          echo "=========================================="
