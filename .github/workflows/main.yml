name: Build Gene Brawl Mod

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: '–¢–∏–ø —Å–±–æ—Ä–∫–∏'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - production
      target_platform:
        description: '–¶–µ–ª–µ–≤–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞'
        required: true
        default: 'gadget'
        type: choice
        options:
          - gadget
          - frida_mac
          - ios_laser
          - ios_laser_dev
          - custom
      custom_command:
        description: '–ö–∞—Å—Ç–æ–º–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ custom)'
        required: false
        default: ''
        type: string
      node_version:
        description: '–í–µ—Ä—Å–∏—è Node.js'
        required: true
        default: '18'
        type: choice
        options:
          - '16'
          - '18'
          - '20'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
      
      - name: üå≥ Show project tree
        run: |
          echo "=========================================="
          echo "üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:"
          echo "=========================================="
          tree -L 3 -I 'node_modules|dist|build' || find . -maxdepth 3 -not -path '*/node_modules/*' -not -path '*/dist/*' -not -path '*/build/*' | head -50
          echo ""
          echo "=========================================="
          echo "üìÑ package.json —Å–∫—Ä–∏–ø—Ç—ã:"
          echo "=========================================="
          cat package.json | grep -A 20 '"scripts"'
          echo ""
          echo "=========================================="
          echo "üîß –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
          echo "=========================================="
          echo "npm install          - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
          echo "npm run build_dev    - DEBUG —Å–±–æ—Ä–∫–∞"
          echo "npm run build        - PRODUCTION —Å–±–æ—Ä–∫–∞"
          echo "npm run gadget       - DEBUG + Gadget mode"
          echo "npm run gadget_prod  - PRODUCTION + Gadget mode"
          echo "npm run frida_mac_dev- DEBUG + Mac/PlayCover"
          echo "npm run ios_laser    - PRODUCTION + iDevice"
          echo "npm run ios_laser_dev- DEBUG + iDevice"
          echo "=========================================="
      
      - name: üîß Setup Node.js ${{ inputs.node_version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: 'npm'
      
      - name: üì¶ Install dependencies
        run: |
          echo "‚¨áÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          npm install
          echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
      
      - name: üèóÔ∏è Build project
        run: |
          echo "=========================================="
          echo "üî® –ù–∞—á–∏–Ω–∞—é —Å–±–æ—Ä–∫—É..."
          echo "–¢–∏–ø: ${{ inputs.build_type }}"
          echo "–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: ${{ inputs.target_platform }}"
          echo "=========================================="
          
          case "${{ inputs.target_platform }}" in
            gadget)
              if [ "${{ inputs.build_type }}" == "production" ]; then
                echo "üöÄ –ó–∞–ø—É—Å–∫: npm run gadget_prod"
                npm run gadget_prod
              else
                echo "üöÄ –ó–∞–ø—É—Å–∫: npm run gadget"
                npm run gadget
              fi
              ;;
            frida_mac)
              echo "üöÄ –ó–∞–ø—É—Å–∫: npm run frida_mac_dev"
              npm run frida_mac_dev
              ;;
            ios_laser)
              echo "üöÄ –ó–∞–ø—É—Å–∫: npm run ios_laser"
              npm run ios_laser
              ;;
            ios_laser_dev)
              echo "üöÄ –ó–∞–ø—É—Å–∫: npm run ios_laser_dev"
              npm run ios_laser_dev
              ;;
            custom)
              echo "üöÄ –ó–∞–ø—É—Å–∫ –∫–∞—Å—Ç–æ–º–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã: ${{ inputs.custom_command }}"
              ${{ inputs.custom_command }}
              ;;
          esac
          
          echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
      
      - name: üìã List build artifacts
        if: always()
        run: |
          echo "=========================================="
          echo "üì¶ –°–æ–∑–¥–∞–Ω–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:"
          echo "=========================================="
          find . -name "*.js" -o -name "*.ts" -o -name "dist" -o -name "build" 2>/dev/null | head -20 || echo "–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏"
          ls -la dist/ 2>/dev/null || ls -la build/ 2>/dev/null || echo "–ü–∞–ø–∫–∏ dist/ –∏–ª–∏ build/ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
          echo "=========================================="
      
      - name: üì§ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gene-brawl-build-${{ inputs.build_type }}-${{ inputs.target_platform }}
          path: |
            dist/
            build/
            *.js
            !node_modules/
          if-no-files-found: warn
          retention-days: 30
      
      - name: üéâ Success message
        if: success()
        run: |
          echo "=========================================="
          echo "‚úÖ –°–ë–û–†–ö–ê –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–ê!"
          echo "=========================================="
          echo "–¢–∏–ø: ${{ inputs.build_type }}"
          echo "–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: ${{ inputs.target_platform }}"
          echo "–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∏ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è"
          echo "=========================================="
