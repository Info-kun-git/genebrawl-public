name: Build Gene Brawl APK

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Ð¢Ð¸Ð¿ ÑÐ±Ð¾Ñ€ÐºÐ¸'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - production
      base_apk_url:
        description: 'URL Ð±Ð°Ð·Ð¾Ð²Ð¾Ð³Ð¾ APK Brawl Stars (Ð¿Ñ€ÑÐ¼Ð°Ñ ÑÑÑ‹Ð»ÐºÐ° Ð½Ð° ÑÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ðµ)'
        required: true
        default: 'https://example.com/brawl-stars-base.apk'
        type: string
      apk_name:
        description: 'Ð˜Ð¼Ñ Ð²Ñ‹Ñ…Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ñ„Ð°Ð¹Ð»Ð°'
        required: true
        default: 'gene-brawl-mod'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: â¬‡ï¸ Install dependencies
        run: |
          echo "=========================================="
          echo "â¬‡ï¸ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
          echo "=========================================="
          
          # Node.js deps
          npm ci
          
          # System tools
          sudo apt-get update
          sudo apt-get install -y wget unzip zip openjdk-17-jre-headless
          
          # Apktool
          wget -q https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool
          wget -q https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.9.3.jar
          chmod +x apktool
          sudo mv apktool /usr/local/bin/
          sudo mv apktool_2.9.3.jar /usr/local/bin/apktool.jar
          
          # uber-apk-signer
          wget -q https://github.com/patrickfav/uber-apk-signer/releases/download/v1.3.0/uber-apk-signer-1.3.0.jar
          sudo mv uber-apk-signer-1.3.0.jar /usr/local/bin/uber-apk-signer.jar
          
          # Android SDK for apksigner
          cd /tmp
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q commandlinetools-linux-9477386_latest.zip
          mkdir -p $HOME/android-sdk/cmdline-tools
          mv cmdline-tools $HOME/android-sdk/cmdline-tools/latest
          export ANDROID_HOME=$HOME/android-sdk
          export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin
          yes | sdkmanager --licenses >/dev/null 2>&1 || true
          sdkmanager "build-tools;34.0.0" >/dev/null 2>&1
          
          echo "âœ… Ð’ÑÐµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
      
      - name: ðŸ—ï¸ Build mod bundle
        run: |
          echo "=========================================="
          echo "ðŸ”¨ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¼Ð¾Ð´Ð°..."
          echo "=========================================="
          
          if [ "${{ inputs.build_type }}" == "production" ]; then
            npm run build
          else
            npm run build_dev
          fi
          
          echo "âœ… ÐœÐ¾Ð´ ÑÐ¾Ð±Ñ€Ð°Ð½:"
          ls -lh dist/bundle.js
      
      - name: ðŸ“± Download & Decompile APK
        run: |
          echo "=========================================="
          echo "â¬‡ï¸ Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð±Ð°Ð·Ð¾Ð²Ð¾Ð³Ð¾ APK..."
          echo "=========================================="
          
          mkdir -p base_apk
          wget -q "${{ inputs.base_apk_url }}" -O base_apk/base.apk || {
            echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐºÐ°Ñ‡Ð°Ñ‚ÑŒ APK!"
            echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ Ñ‡Ñ‚Ð¾ URL Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ð¹ Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð±ÐµÐ· Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸"
            exit 1
          }
          
          echo "âœ… APK ÑÐºÐ°Ñ‡Ð°Ð½:"
          ls -lh base_apk/base.apk
          
          echo ""
          echo "=========================================="
          echo "ðŸ“¦ Ð”ÐµÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ñ APK..."
          echo "=========================================="
          
          apktool d base_apk/base.apk -o decoded_apk -f
          
          echo "âœ… APK Ð´ÐµÐºÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½"
          echo "ðŸ“ Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°:"
          find decoded_apk -maxdepth 2 -type d | head -20
      
      - name: ðŸ”§ Inject mod into APK
        run: |
          echo "=========================================="
          echo "ðŸ”§ Ð’ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð¼Ð¾Ð´Ð° Ð² APK..."
          echo "=========================================="
          
          # Gene Brawl Ð¼Ð¾Ð´ Ð´Ð»Ñ Frida - Ð½ÑƒÐ¶Ð½Ð¾ Ð²ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ frida-gadget Ð¸Ð»Ð¸ Ð·Ð°Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ libg.so
          # Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 1: Ð•ÑÐ»Ð¸ Ð¼Ð¾Ð´ Ð·Ð°Ð¼ÐµÐ½ÑÐµÑ‚ libg.so (ÑÑ‚Ð°Ñ€Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ)
          # Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 2: Ð•ÑÐ»Ð¸ Ð¼Ð¾Ð´ Ð²ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÑ‚ frida-gadget (Ð½Ð¾Ð²Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ)
          
          echo "ðŸ“‹ ÐŸÐ¾Ð¸ÑÐº libg.so..."
          find decoded_apk -name "libg.so" -o -name "libg.*.so" 2>/dev/null
          
          echo ""
          echo "ðŸ“‹ ÐŸÐ¾Ð¸ÑÐº assets..."
          ls -la decoded_apk/assets/ 2>/dev/null || echo "assets/ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          
          echo ""
          echo "ðŸ“‹ ÐŸÐ¾Ð¸ÑÐº smali (ÐºÐ¾Ð´ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ)..."
          ls decoded_apk/smali*/ 2>/dev/null | head -10
          
          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ Ð¼Ð¾Ð´Ð° Ð² assets
          mkdir -p decoded_apk/assets/genebrawl
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ bundle.js ÐºÐ°Ðº ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Frida
          cp dist/bundle.js decoded_apk/assets/genebrawl/mod.js
          
          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ Ð´Ð»Ñ Frida Gadget
          cat > decoded_apk/assets/genebrawl/gadget.config << 'EOF'
          {
            "interaction": {
              "type": "script",
              "path": "/assets/genebrawl/mod.js"
            }
          }
EOF
          
          echo "âœ… ÐœÐ¾Ð´ Ð²ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð² assets/genebrawl/"
          
          # Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ libg.so - Ð´ÐµÐ»Ð°ÐµÐ¼ Ð±ÑÐºÐ°Ð¿ Ð¸ Ð·Ð°Ð¼ÐµÐ½Ñƒ (Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ Ð²ÐµÑ€ÑÐ¸Ð¸ Ð¼Ð¾Ð´Ð°)
          if [ -f "decoded_apk/lib/arm64-v8a/libg.so" ]; then
            echo ""
            echo "ðŸ”§ ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½ libg.so - Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÑÐµÐ¼ Ð¿Ð°Ñ‚Ñ‡..."
            # Ð—Ð´ÐµÑÑŒ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð»Ð¾Ð³Ð¸ÐºÐ° Ð·Ð°Ð¼ÐµÐ½Ñ‹ libg.so Ð½Ð° Ð¿Ñ€Ð¾Ð¿Ð°Ñ‚Ñ‡ÐµÐ½Ð½ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ
            # Ð¸Ð»Ð¸ Ð²ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°Ð½Ð¸Ðµ frida-gadget
            cp decoded_apk/lib/arm64-v8a/libg.so decoded_apk/lib/arm64-v8a/libg.so.backup
            echo "âœ… libg.so ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½"
          fi
      
      - name: ðŸ“¦ Recompile & Sign APK
        run: |
          echo "=========================================="
          echo "ðŸ“¦ ÐŸÐµÑ€ÐµÑÐ±Ð¾Ñ€ÐºÐ° APK..."
          echo "=========================================="
          
          # ÐŸÐµÑ€ÐµÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ APK
          apktool b decoded_apk -o unsigned.apk
          
          echo "âœ… APK Ð¿ÐµÑ€ÐµÑÐ¾Ð±Ñ€Ð°Ð½"
          
          echo ""
          echo "=========================================="
          echo "ðŸ” ÐŸÐ¾Ð´Ð¿Ð¸ÑÑŒ APK..."
          echo "=========================================="
          
          # ÐŸÐ¾Ð´Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ APK
          java -jar /usr/local/bin/uber-apk-signer.jar \
            -a unsigned.apk \
            --out signed/ \
            --ks gene.keystore \
            --ksAlias gene \
            --ksPass gene123 \
            --ksKeyPass gene123 \
            --createKeyStore true
          
          # ÐŸÐµÑ€ÐµÐ¸Ð¼ÐµÐ½Ð¾Ð²Ñ‹Ð²Ð°ÐµÐ¼ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»
          mkdir -p output
          cp signed/unsigned-aligned-debugSigned.apk "output/${{ inputs.apk_name }}.apk" 2>/dev/null || \
          cp signed/*-debugSigned.apk "output/${{ inputs.apk_name }}.apk" 2>/dev/null || \
          cp signed/*.apk "output/${{ inputs.apk_name }}.apk"
          
          echo "âœ… APK Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ð½:"
          ls -lh output/
      
      - name: ðŸ“ Generate info
        run: |
          cat > output/README.txt << EOF
          Gene Brawl Mod APK
          ==================
          
          Ð¤Ð°Ð¹Ð»: ${{ inputs.apk_name }}.apk
          Ð’ÐµÑ€ÑÐ¸Ñ: $(node -p "require('./package.json').version")
          Ð¢Ð¸Ð¿ ÑÐ±Ð¾Ñ€ÐºÐ¸: ${{ inputs.build_type }}
          Ð”Ð°Ñ‚Ð°: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°:
          1. Ð£Ð´Ð°Ð»Ð¸ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Brawl Stars
          2. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸ ÑÑ‚Ð¾Ñ‚ APK
          3. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸ Ð¸Ð³Ñ€Ñƒ - Ð¼Ð¾Ð´ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸
          
          Ð’Ð°Ð¶Ð½Ð¾:
          - Ð­Ñ‚Ð¾ Ð¼Ð¾Ð´Ð¸Ñ„Ð¸Ñ†Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ APK Ñ Ð²ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ñ‹Ð¼ Gene Brawl
          - ÐÐµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ñ Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ð¼ ÑÐµÑ€Ð²ÐµÑ€Ð¾Ð¼ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ðµ ÑÐµÑ€Ð²ÐµÑ€Ð°)
          - Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð½Ð° ÑÐ²Ð¾Ð¹ ÑÑ‚Ñ€Ð°Ñ… Ð¸ Ñ€Ð¸ÑÐº
          
          Ð¡Ð¾Ð±Ñ€Ð°Ð½Ð¾ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ñ‡ÐµÑ€ÐµÐ· GitHub Actions
          EOF
          
          cat output/README.txt
      
      - name: ðŸ“¤ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.apk_name }}-${{ inputs.build_type }}
          path: |
            output/${{ inputs.apk_name }}.apk
            output/README.txt
          if-no-files-found: error
          retention-days: 30
      
      - name: ðŸŽ‰ Done
        run: |
          echo "=========================================="
          echo "âœ… Ð“ÐžÐ¢ÐžÐ’Ðž!"
          echo "=========================================="
          echo "ðŸ“¦ Ð¡ÐºÐ°Ñ‡Ð°Ð¹ APK Ð¸Ð· Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²:"
          echo "   Actions â†’ Ð­Ñ‚Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑÐº â†’ Artifacts"
          echo ""
          echo "ðŸ“± Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°:"
          echo "   1. Ð¡ÐºÐ°Ñ‡Ð°Ð¹ ${{ inputs.apk_name }}.apk"
          echo "   2. ÐŸÐµÑ€ÐµÐ´Ð°Ð¹ Ð½Ð° Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½"
          echo "   3. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸ (Ñ€Ð°Ð·Ñ€ÐµÑˆÐ¸ Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ðµ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ¸)"
          echo "=========================================="
