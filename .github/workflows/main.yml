name: Build Gene Brawl Frida Mod

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Ð¢Ð¸Ð¿ ÑÐ±Ð¾Ñ€ÐºÐ¸'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug (development)
          - production
      obfuscate:
        description: 'ÐžÐ±Ñ„ÑƒÑÑ†Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÐ¾Ð´? (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ production)'
        required: true
        default: true
        type: boolean
      compile_bytecode:
        description: 'ÐšÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Ð±Ð°Ð¹Ñ‚ÐºÐ¾Ð´? (compile_bytecode.py)'
        required: true
        default: false
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          echo "=========================================="
          echo "â¬‡ï¸ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
          echo "=========================================="
          npm ci
          echo "âœ… Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
          
          echo ""
          echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹:"
          ls -la
          echo ""
          echo "ðŸ“„ Ð¡ÐºÑ€Ð¸Ð¿Ñ‚Ñ‹ package.json:"
          cat package.json | grep -A 15 '"scripts"'
      
      - name: ðŸ—ï¸ Build bundle.js
        run: |
          echo "=========================================="
          echo "ðŸ”¨ Ð¡Ð±Ð¾Ñ€ÐºÐ° Gene Brawl Mod..."
          echo "=========================================="
          
          if [ "${{ inputs.build_type }}" == "production" ]; then
            echo "ðŸš€ Ð ÐµÐ¶Ð¸Ð¼: PRODUCTION (Ñ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸ÐµÐ¹)"
            npm run build
          else
            echo "ðŸš€ Ð ÐµÐ¶Ð¸Ð¼: DEBUG (Ñ source maps)"
            npm run build_dev
          fi
          
          echo ""
          echo "=========================================="
          echo "ðŸ“ Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ ÑÐ±Ð¾Ñ€ÐºÐ¸:"
          echo "=========================================="
          ls -lh dist/
          
          echo ""
          echo "ðŸ“Š Ð Ð°Ð·Ð¼ÐµÑ€ Ñ„Ð°Ð¹Ð»Ð¾Ð²:"
          du -h dist/*
      
      - name: ðŸ”’ Obfuscate check
        if: inputs.build_type == 'production' && inputs.obfuscate == true
        run: |
          echo "=========================================="
          echo "ðŸ”’ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¾Ð±Ñ„ÑƒÑÐºÐ°Ñ†Ð¸Ð¸..."
          echo "=========================================="
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð¾Ð±Ñ„ÑƒÑÐºÐ°Ñ‚Ð¾Ñ€ Ð¾Ñ‚Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð»
          if grep -q "var _0x" dist/bundle.js 2>/dev/null; then
            echo "âœ… ÐžÐ±Ñ„ÑƒÑÐºÐ°Ñ†Ð¸Ñ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð° (Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ _0x Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ)"
          else
            echo "âš ï¸ ÐžÐ±Ñ„ÑƒÑÐºÐ°Ñ†Ð¸Ñ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð° Ð² obfuscator.json"
          fi
          
          # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€Ð²Ñ‹Ðµ 20 ÑÑ‚Ñ€Ð¾Ðº Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
          echo ""
          echo "ðŸ” ÐŸÐµÑ€Ð²Ñ‹Ðµ 20 ÑÑ‚Ñ€Ð¾Ðº bundle.js:"
          head -20 dist/bundle.js
      
      - name: âš¡ Compile to Bytecode (optional)
        if: inputs.compile_bytecode == true
        run: |
          echo "=========================================="
          echo "âš¡ ÐšÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ñ Ð² Ð±Ð°Ð¹Ñ‚ÐºÐ¾Ð´..."
          echo "=========================================="
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ compile_bytecode.py ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
          if [ -f "tools/compile_bytecode.py" ]; then
            python3 tools/compile_bytecode.py dist/bundle.js
            echo "âœ… Ð‘Ð°Ð¹Ñ‚ÐºÐ¾Ð´ ÑÐ¾Ð·Ð´Ð°Ð½"
            
            echo ""
            echo "ðŸ“ Ð¤Ð°Ð¹Ð»Ñ‹ Ð¿Ð¾ÑÐ»Ðµ ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ð¸:"
            ls -lh dist/
          else
            echo "âŒ tools/compile_bytecode.py Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
            exit 1
          fi
      
      - name: ðŸ“‹ Generate info file
        run: |
          echo "=========================================="
          echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ info.txt..."
          echo "=========================================="
          
          cat > dist/info.txt << EOF
          Gene Brawl Mod Build Info
          ===========================
          Build Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          Build Type: ${{ inputs.build_type }}
          Version: $(node -p "require('./package.json').version")
          Git Commit: ${{ github.sha }}
          Git Branch: ${{ github.ref_name }}
          
          Files:
          $(ls -lh dist/ | tail -n +2)
          
          Usage:
          - DEBUG: frida -U Gadget -l dist/bundle.js
          - iOS: frida -U -f com.supercell.laser -l dist/bundle.js
          - Mac: frida -f /Applications/gene.brawl.dev.app/laser -l dist/bundle.js
          EOF
          
          cat dist/info.txt
      
      - name: ðŸ“¤ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gene-brawl-${{ inputs.build_type }}-${{ github.run_number }}
          path: |
            dist/
            !dist/*.map
          if-no-files-found: error
          retention-days: 30
      
      - name: ðŸŽ‰ Success
        run: |
          echo "=========================================="
          echo "âœ… Ð¡Ð‘ÐžÐ ÐšÐ Ð£Ð¡ÐŸÐ•Ð¨ÐÐž Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐ!"
          echo "=========================================="
          echo "ðŸ“¦ ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹: gene-brawl-${{ inputs.build_type }}-${{ github.run_number }}"
          echo ""
          echo "ðŸ”§ ÐšÐ°Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ:"
          echo "  1. Ð¡ÐºÐ°Ñ‡Ð°Ð¹ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ Ð¸Ð· Actions"
          echo "  2. Ð Ð°ÑÐ¿Ð°ÐºÑƒÐ¹ dist/ Ð¿Ð°Ð¿ÐºÑƒ"
          echo "  3. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸ Frida Ñ bundle.js:"
          echo ""
          
          if [ "${{ inputs.build_type }}" == "debug" ]; then
            echo "     frida -U Gadget -l dist/bundle.js"
          else
            echo "     frida -U -f com.supercell.laser -l dist/bundle.js --no-pause"
          fi
          
          echo ""
          echo "ðŸ’¡ Ð”Ð»Ñ iOS: ÑƒÐ±ÐµÐ´Ð¸ÑÑŒ Ñ‡Ñ‚Ð¾ bundle ID com.supercell.laser"
          echo "=========================================="
